<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>情緒轉化花園</title>
    <style>
        /* --- 1. 基礎設定 --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #0b0d17;
            background-image: radial-gradient(circle at center, #1a1d2e 0%, #0b0d17 70%);
            color: #ffffff;
            font-family: "Noto Serif TC", "Songti TC", serif; 
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* --- 2. 輸入介面 --- */
        #input-container {
            position: absolute;
            z-index: 10;
            text-align: center;
            transition: opacity 1s, visibility 1s;
        }

        textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            color: #eee;
            font-size: 1.1rem;
            outline: none;
            padding: 10px;
            width: 320px;
            text-align: center;
            font-family: inherit;
            resize: none;
            letter-spacing: 1px;
        }

        textarea::placeholder {
            color: rgba(255, 255, 255, 0.2);
            font-style: italic;
        }

        #release-btn {
            margin-top: 35px;
            padding: 12px 35px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            letter-spacing: 3px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        #btn-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background-color: rgba(255, 255, 255, 0.15);
            transition: width 0.1s linear;
            z-index: 0;
        }
        
        #btn-text { position: relative; z-index: 1; }

        /* --- 3. 雲朵文字 --- */
        .cloud-text {
            position: absolute;
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.3rem;
            pointer-events: none;
            transition: top 2s ease-in, opacity 1.5s;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
            font-weight: 300;
        }
        .raining { opacity: 0.2; }

        /* --- 4. 花朵生長 (SVG 描邊動畫) --- */
        #garden {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            pointer-events: none;
            z-index: 5;
        }

        .flower-container {
            position: relative;
            width: 80px;
            height: 250px;
            margin: 0 -20px; 
            overflow: visible;
        }

        .flower-svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 0 3px rgba(200, 220, 255, 0.2)); 
            overflow: visible;
        }
        
        /* 線條設定：利用 dasharray 實現慢慢畫出來 */
        .flower-svg path {
            fill: none;
            stroke: rgba(255, 255, 255, 0.6);
            stroke-width: 0.8;
            stroke-linecap: round;
            /* 這些數值會由 JS 動態計算 */
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000; 
            transition: stroke-dashoffset 5s ease-in-out; /* 5秒慢慢畫完 */
        }

        /* 花苞圓點 */
        .flower-svg circle {
            opacity: 0;
            transition: opacity 2s ease-in; 
            transition-delay: 3.5s; /* 等線條畫得差不多再出現 */
        }

        /* 生長觸發 */
        .flower-container.grow path {
            stroke-dashoffset: 0; /* 歸零 = 線條完全顯示 */
        }
        
        .flower-container.grow circle {
            opacity: 1;
        }

        /* --- 5. 狀態文字 --- */
        #status-text {
            position: absolute;
            top: 15%;
            font-size: 1.1rem;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.4);
            opacity: 0;
            transition: opacity 1.5s;
        }
    </style>
</head>
<body>

    <audio id="rain-audio" src="rain.mp3" preload="auto" loop></audio>

    <div id="status-text">消失的地方會長出花來</div>
    <div id="sky"></div>

    <div id="input-container">
        <textarea id="mood-input" rows="1" placeholder="輸入你的煩惱..."></textarea>
        <br>
        <button id="release-btn">
            <div id="btn-progress"></div>
            <span id="btn-text">長按釋放</span>
        </button>
    </div>

    <div id="garden"></div>

    <script>
        const input = document.getElementById('mood-input');
        const sky = document.getElementById('sky');
        const btn = document.getElementById('release-btn');
        const btnProgress = document.getElementById('btn-progress');
        const btnText = document.getElementById('btn-text');
        const inputContainer = document.getElementById('input-container');
        const garden = document.getElementById('garden');
        const statusText = document.getElementById('status-text');
        const rainAudio = document.getElementById('rain-audio');

        let textElements = [];
        let pressTimer;
        let isRaining = false;

        rainAudio.volume = 0.5;

        // 1. 文字雲
        input.addEventListener('input', (e) => {
            if(isRaining) return;
            updateCloud(e.target.value);
            input.style.height = 'auto';
            input.style.height = input.scrollHeight + 'px';
        });

        function updateCloud(text) {
            sky.innerHTML = '';
            textElements = [];
            const chars = text.split('');
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 3;

            chars.forEach((char) => {
                if (char.trim() === '') return;
                const span = document.createElement('span');
                span.innerText = char;
                span.classList.add('cloud-text');
                
                const spreadX = window.innerWidth * 0.4; 
                const spreadY = window.innerHeight * 0.15;
                const offsetX = (Math.random() - 0.5) * spreadX; 
                const offsetY = (Math.random() - 0.5) * spreadY;
                
                span.style.left = `${centerX + offsetX - 10}px`;
                span.style.top = `${centerY + offsetY}px`;
                
                const scale = 0.9 + Math.random() * 0.6;
                span.style.transform = `scale(${scale}) rotate(${Math.random()*20 - 10}deg)`;
                span.style.opacity = 0.3 + Math.random() * 0.4;
                
                sky.appendChild(span);
                textElements.push(span);
            });
        }

        // 2. 長按互動
        const PRESS_DURATION = 2000;
        
        ['mousedown', 'touchstart'].forEach(evt => btn.addEventListener(evt, startPress));
        ['mouseup', 'mouseleave', 'touchend'].forEach(evt => btn.addEventListener(evt, cancelPress));

        function startPress(e) {
            if(isRaining || input.value.trim() === "") return;
            btnText.innerText = "釋放中...";
            btnProgress.style.transition = `width ${PRESS_DURATION}ms linear`;
            btnProgress.style.width = "100%";
            pressTimer = setTimeout(triggerRain, PRESS_DURATION);
        }

        function cancelPress() {
            if(isRaining) return;
            clearTimeout(pressTimer);
            btnProgress.style.transition = "width 0.3s ease-out";
            btnProgress.style.width = "0%";
            btnText.innerText = "長按釋放";
        }

        // 3. 下雨與播放聲音
        function triggerRain() {
            isRaining = true;
            
            // 嘗試播放聲音
            rainAudio.play().catch(e => console.log("需互動後才能播放"));

            inputContainer.style.opacity = '0';
            inputContainer.style.visibility = 'hidden';

            textElements.forEach((el, index) => {
                setTimeout(() => {
                    el.classList.add('raining');
                    el.style.top = `${window.innerHeight + 100}px`;
                }, index * 30 + Math.random() * 800);
            });

            setTimeout(() => { statusText.style.opacity = 1; }, 1500);
            setTimeout(growFlowers, 2000); 
        }

        // 4. 線條花朵 SVG 定義
        const flowerSVGs = [
            // A: 長曲線
            `<svg class="flower-svg" viewBox="0 0 100 300" preserveAspectRatio="xMidYMax slice">
                <path d="M50,300 Q50,200 60,150 T80,50" />
                <path d="M60,150 Q40,120 30,100" />
                <circle cx="80" cy="50" r="3" fill="rgba(255,255,255,0.8)"/>
                <circle cx="30" cy="100" r="2" fill="rgba(255,255,255,0.6)"/>
            </svg>`,
            // B: 蜿蜒向上
            `<svg class="flower-svg" viewBox="0 0 100 300" preserveAspectRatio="xMidYMax slice">
                 <path d="M50,300 C40,200 80,150 40,50" />
                 <circle cx="40" cy="50" r="4" fill="rgba(255,255,255,0.8)"/>
                 <circle cx="45" cy="55" r="2" fill="rgba(255,255,255,0.4)"/>
            </svg>`,
            // C: 雙分岔
            `<svg class="flower-svg" viewBox="0 0 100 300" preserveAspectRatio="xMidYMax slice">
                <path d="M50,300 Q55,200 50,150" />
                <path d="M50,150 C50,100 20,80 20,40" />
                <path d="M50,150 C50,100 80,80 80,60" />
                <circle cx="20" cy="40" r="2.5" fill="rgba(255,255,255,0.7)"/>
                <circle cx="80" cy="60" r="3" fill="rgba(255,255,255,0.7)"/>
            </svg>`
        ];

        function growFlowers() {
            const flowerCount = Math.min(Math.max(textElements.length / 2, 6), 12); 

            for(let i=0; i<flowerCount; i++) {
                const container = document.createElement('div');
                container.classList.add('flower-container');
                container.innerHTML = flowerSVGs[Math.floor(Math.random() * flowerSVGs.length)];
                
                container.style.left = `${(Math.random() - 0.5) * 20}px`; 
                const scale = 0.7 + Math.random() * 0.5;
                container.style.transform = `scale(${scale})`;
                
                garden.appendChild(container);

                // 計算路徑長度 (SVG Stroke Animation 核心)
                const paths = container.querySelectorAll('path');
                paths.forEach(path => {
                    const length = path.getTotalLength();
                    path.style.strokeDasharray = length;
                    path.style.strokeDashoffset = length;
                });

                // 錯開生長
                setTimeout(() => {
                    container.classList.add('grow');
                }, i * 800 + Math.random() * 1000); 
            }
        }
    </script>
</body>
</html>